<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="keywords" content="docker，linux">
<meta name="description" content="温故而知新">
<meta name="theme-color" content="#000">
<title>k8s高可用集群搭建过程 | 我的笔记</title>
<link rel="shortcut icon" href="https://glwlg.top/favicon.ico?v=1681272507278">
<link rel="stylesheet" href="https://glwlg.top/styles/main.css">

<link rel="stylesheet" href="/media/css/mist.css">

<link rel="stylesheet" href="/media/fonts/font-awesome.css">
<link href="//fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Rosario:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">

<link href="/media/hljs/styles/androidstudio.css" rel="stylesheet">  

<script src="/media/hljs/highlight.js"></script>
<script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.0/velocity.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.0/velocity.ui.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js" integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous"
    onload="renderMathInElement(document.body);"></script>

    <meta name="description" content="k8s高可用集群搭建过程" />
    <meta name="keywords" content="kubernetes,k8s,docker" />
  </head>
  <body>
    <div class="head-top-line"></div>
    <div class="header-box">
      
<div class=" mist">
  <header class="header bg-color ">
    <div class="blog-header box-shadow-wrapper  " id="header">
      <div class="nav-toggle" id="nav_toggle">
        <div class="toggle-box">
          <div class="line line-top"></div>
          <div class="line line-center"></div>
          <div class="line line-bottom"></div>
        </div>
      </div>
      <div class="site-meta">       
        <div class="site-title">
          
            <a href="/" class="">
              <span class="logo-line-before">
                <i class=""></i>
              </span>
              <span class="main-title">我的笔记</span>
              <span class="logo-line-after">
                <i class=""></i>
              </span>
            </a>  
          
        </div>
        
      </div>
      <nav class="site-nav" id="site_nav">
        <ul id="nav_ul">
          
            <li class="nav-item ">
              
                <a href="/">
                  <i class="fa fa-home"></i> 首页
                </a>
              
            </li>
          
            <li class="nav-item ">
              
                <a href="/archives">
                  <i class="fa fa-archive"></i> 归档
                </a>
              
            </li>
          
            <li class="nav-item ">
              
                <a href="/tags">
                  <i class="fa fa-tags"></i> 标签
                </a>
              
            </li>
          
            <li class="nav-item ">
              
                <a href="/post/about">
                  <i class="fa fa-user"></i> 关于
                </a>
              
            </li>
          
          <li class="nav-item">
            <a>
              <i class="fa fa-search"></i> 搜索
            </a>
          </li>
        </ul>
      </nav>
    </div>
  </header>
</div>

<script type="text/javascript"> 
 
  let showNav = true;

  let navToggle = document.querySelector('#nav_toggle'),
  siteNav = document.querySelector('#site_nav');
  
  function navClick() {
    let sideBar = document.querySelector('.sidebar');
    let navUl = document.querySelector('#nav_ul');
    navToggle.classList.toggle('nav-toggle-active');
    siteNav.classList.toggle('nav-menu-active');
    if (siteNav.classList.contains('nav-menu-active')) {
      siteNav.style = "height: " + (navUl.children.length * 42) +"px !important";
    } else {
      siteNav.style = "";
    }
  }

  navToggle.addEventListener('click',navClick);  
</script>
    </div>
    <div class="main-continer">
      
      <div class="section-layout mist bg-color">
        <div class="section-layout-wrapper">
          

<div class="sidebar">
    <div class="sidebar-box box-shadow-wrapper  right-motion" id="sidebar">
      
        <div class="post-list-sidebar">
          <div class="sidebar-title">
            <span id="tocSideBar" class="sidebar-title-item sidebar-title-active">文章目录</span>
            <span id="metaSideBar" class="sidebar-title-item">站点概览</span>
          </div>
        </div>
      
      <div class="sidebar-body mist" id="sidebar_body">
        
          <div class="post-side-meta" id="post_side_meta">
            
<div class="sidebar-wrapper box-shadow-wrapper ">
  <div class="sidebar-item">
    <img class="site-author-image right-motion" src="https://glwlg.top/images/avatar.png"/>
    <p class="site-author-name">我的笔记</p>
    <p class="site-description right-motion">一些笔记</p>
  </div>
  <div class="sidebar-item side-item-stat right-motion">
    <div class="sidebar-item-box">
      <a href="/archives/">
        
        <span class="site-item-stat-count">25</span>
        <span class="site-item-stat-name">文章</span>
      </a>
    </div>
    <div class="sidebar-item-box">
      <a href="">
        <span class="site-item-stat-count">20</span>
        <span class="site-item-stat-name">分类</span>
      </a>
    </div>
    <div class="sidebar-item-box">
      <a href="/tags/">
        <span class="site-item-stat-count">20</span>
        <span class="site-item-stat-name">标签</span>
      </a>
    </div>
  </div>
  
  


</div>
          </div>
          <div class="post-toc sidebar-body-active" id="post_toc" style="opacity: 1;">
            <div class="toc-box right-motion">
  <div class="toc-wrapper auto-number compress" id="toc_wrapper">
    <ul class="markdownIt-TOC">
<li><a href="#%E4%B8%80%E5%9F%BA%E7%A1%80%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA">一.基础环境搭建</a>
<ul>
<li><a href="#11%E7%B3%BB%E7%BB%9F%E9%85%8D%E7%BD%AE">1.1系统配置</a></li>
<li><a href="#12%E5%AE%89%E8%A3%85docker">1.2安装Docker</a></li>
<li><a href="#2%E5%AE%89%E8%A3%85kubeadm%E5%92%8Ckubelet">2.安装kubeadm和kubelet</a></li>
</ul>
</li>
<li><a href="#%E4%BA%8C%E9%9B%86%E7%BE%A4%E5%88%9D%E5%A7%8B%E5%8C%96">二.集群初始化</a>
<ul>
<li><a href="#21-etcd%E9%9B%86%E7%BE%A4">2.1 etcd集群</a></li>
<li><a href="#22-kubeadm%E5%88%9D%E5%A7%8B%E5%8C%96">2.2 kubeadm初始化</a></li>
<li><a href="#23-flannel%E7%BD%91%E7%BB%9C%E7%BB%84%E4%BB%B6%E5%AE%89%E8%A3%85">2.3 flannel网络组件安装</a>
<ul>
<li><a href="#rbac%E9%85%8D%E7%BD%AE">rbac配置</a></li>
<li><a href="#flannel%E9%85%8D%E7%BD%AE">flannel配置</a></li>
</ul>
</li>
<li><a href="#24-dashboard">2.4 dashboard</a>
<ul>
<li><a href="#rbac%E9%85%8D%E7%BD%AE-2">rbac配置</a></li>
<li><a href="#dashboard%E9%85%8D%E7%BD%AE">dashboard配置</a></li>
<li><a href="#heapster%E7%BB%84%E4%BB%B6%E5%AE%89%E8%A3%85">heapster组件安装</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#%E4%B8%89master%E9%9B%86%E7%BE%A4%E9%AB%98%E5%8F%AF%E7%94%A8%E8%AE%BE%E7%BD%AE">三.master集群高可用设置</a>
<ul>
<li><a href="#31-%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE">3.1 修改配置</a></li>
<li><a href="#32-%E9%AA%8C%E8%AF%81">3.2 验证</a></li>
<li><a href="#33-keepalived%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE">3.3 keepalived安装配置</a></li>
<li><a href="#34-nginx%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E9%85%8D%E7%BD%AE">3.4 nginx负载均衡配置</a></li>
<li><a href="#35-kube-proxy%E9%85%8D%E7%BD%AE">3.5 kube-proxy配置</a></li>
</ul>
</li>
<li><a href="#%E5%9B%9B-node%E8%8A%82%E7%82%B9%E5%8A%A0%E5%85%A5%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%E8%AE%BE%E7%BD%AE">四. node节点加入高可用集群设置</a></li>
</ul>

  </div>
</div>

<script>

let lastTop = 0, lList = [], hList = [], postBody, lastIndex = -1; 
let active = 'active-show', activeClass = 'active-current';
let tocWrapper = document.querySelector('#toc_wrapper');
let tocContent = tocWrapper.children[0];
let autoNumber = tocWrapper&&tocWrapper.classList.contains('auto-number');

function addTocNumber(elem, deep) {
  if (!elem) {
    return;
  }
  let prop = elem.__proto__;

  if (prop === HTMLUListElement.prototype) {
    for (let i = 0; i < elem.children.length; i++) {
      addTocNumber(elem.children[i], deep + (i + 1) + '.');
    }
  } else if (prop === HTMLLIElement.prototype) {
    // 保存li元素
    lList.push(elem);
    for (let i = 0; i < elem.children.length; i++) {
      let cur = elem.children[i];
      if (cur.__proto__ === HTMLAnchorElement.prototype) {
        if (autoNumber) {
          cur.text =  deep + ' ' + cur.text;
        }
      } else if (cur.__proto__ === HTMLUListElement.prototype) {
        addTocNumber(cur, deep);
      }
    }
  }
}


document.addEventListener('scroll', function(e) {
  if (lList.length <= 0) {
    return;
  }
  let scrollTop = document.scrollingElement.scrollTop;
  let dir;

  if (lastTop - scrollTop > 0) {
    dir = 'up';
  } else {
    dir = 'down';
  }

  lastTop = scrollTop;
  if (scrollTop <= 0) {
    if (lastIndex >= 0 && lastIndex < hList.length) {
      lList[lastIndex].classList.remove(activeClass);
    }
    return;
  }

  let current = 0, hasFind = false;
  for (let i = 0; i < hList.length; i++) {
    if (hList[i].offsetTop > scrollTop) {
      current = i;
      hasFind = true;
      break;
    }
  }
  if (!hasFind && scrollTop > lList[lList.length - 1].offsetTop) {
    current = hList.length - 1;
  } else {
    current--;
  }
  if (dir === 'down') {
    if (current > lastIndex) {
      addActiveClass(current);
      removeActiveClass(lastIndex) 
      lastIndex = current;
      removeParentActiveClass();
      lList[current] && addActiveLiElemment(lList[current].parentElement,tocContent);
    }
  } else {
    if (current < lastIndex) {
      addActiveClass(current);
      removeActiveClass(lastIndex);
      lastIndex = current;
      removeParentActiveClass();
      lList[current] && addActiveLiElemment(lList[current].parentElement,tocContent);
    }
  }
});

function removeParentActiveClass() {
  let parents = tocContent.querySelectorAll('.'+active)
  parents.forEach(function(elem) {
    elem.classList.remove(active);
  });
}

function addActiveClass(index) {
  if (index >= 0 && index < hList.length) {
    lList[index].classList.add(activeClass);
  }
}

function removeActiveClass(index) {
  if (index >= 0 && index < hList.length) {
    lList[index].classList.remove(activeClass);
  }
}

function addActiveLiElemment(elem, parent) {
  if (!elem || elem === parent) {
    return;
  } else {
    if (elem.__proto__ === HTMLLIElement.prototype) {
      elem.classList.add(active);
    }
    addActiveLiElemment(elem.parentElement, parent);
  }
}

function showToc() {
  if (tocWrapper) {
    postBody = document.querySelector('#post_body');
    for (let i = 0; i < postBody.children.length; i++) {
      if (postBody.children[i].__proto__ === HTMLHeadingElement.prototype) {
        hList.push(postBody.children[i]);
      }
    }
    if (tocWrapper.classList.contains('compress')) {
        tocContent.classList.add('closed');
    } else if (tocWrapper.classList.contains('no_compress')){
      tocContent.classList.add('expanded');
    } else {
      if (hList.length > 10) {
        active = 'active-hidden'
        tocContent.classList.add('closed');
      } else {
        tocContent.classList.add('expanded');
      }
    }
  }
}
addTocNumber(tocContent, '');

window.addEventListener('load', function() {
  showToc();
  document.querySelector('#sidebar').style='display: block;';
  tocWrapper.classList.add('toc-active');
  setTimeout(function() {
    if ("createEvent" in document) {
      let evt = document.createEvent("HTMLEvents");
      evt.initEvent("scroll", false, true);
      document.dispatchEvent(evt);
    }
    else {
      document.fireEvent("scroll");
    }
  }, 500)
})

</script>
          </div>
        
      </div>
    </div>
</div>
<script>
  const SIDEBAR_TITLE_ACTIVE = 'sidebar-title-active';
  const SIDEBAR_BODY_ACTIVE = 'sidebar-body-active';
  const SLIDE_UP_IN = 'slide-up-in';

  let sidebar = document.querySelector('#sidebar'),
  tocSideBar = document.querySelector('#tocSideBar'),
  metaSideBar = document.querySelector('#metaSideBar'),
  postToc = document.querySelector('#post_toc'),
  postSiteMeta = document.querySelector('#post_side_meta'),
  sidebarTitle = document.querySelector('.sidebar-title'),
  sidebarBody = document.querySelector('#sidebar_body');

  tocSideBar && tocSideBar.addEventListener('click', (e) => {
    toggleSidebar(e);
  });

  metaSideBar && metaSideBar.addEventListener('click', (e) => {
    toggleSidebar(e);
  });

  function toggleSidebar(e) {
    let currentTitle = document.querySelector("."+SIDEBAR_TITLE_ACTIVE);
    if (currentTitle == e.srcElement) {
      return ;
    }
    let current, showElement, hideElement;
    if (e.srcElement == metaSideBar) {
      showElement = postSiteMeta;
      hideElement = postToc;
    } else if (e.srcElement == tocSideBar){
      showElement = postToc;
      hideElement = postSiteMeta;
    }
    currentTitle.classList.remove(SIDEBAR_TITLE_ACTIVE);
    e.srcElement.classList.add(SIDEBAR_TITLE_ACTIVE);

    window.Velocity(hideElement, 'stop');
    window.Velocity(hideElement, 'transition.slideUpOut', {
      display: 'none',
      duration: 200,
      complete: function () {
        window.Velocity(showElement, 'transition.slideDownIn', {
          duration: 200
        });
      }
    })
    hideElement.classList.remove(SIDEBAR_BODY_ACTIVE);
    showElement.classList.add(SIDEBAR_BODY_ACTIVE);
  }

  postToc.addEventListener('transitionend', function() {
    this.classList.remove(SLIDE_UP_IN);
  });


  if (sidebarBody.classList.contains('pisces') || sidebarBody.classList.contains('gemini')) {
    let hasFix = false;
    let scrollEl = document.querySelector('.main-continer');
    let limitTop = document.querySelector('#nav_ul').children.length * 42 + 162;
    window.addEventListener('scroll', function(e) {
    if (document.scrollingElement.scrollTop >= limitTop) {
      if (!hasFix) {
        sidebar.classList.add('sidebar-fixed');
        hasFix = true;
      }
    } else {
      if (hasFix) {
        sidebar.classList.remove('sidebar-fixed');
        hasFix = false;
      }
    }
  });
  }
  
</script>
          <div class="section-box box-shadow-wrapper">
            <div class="section bg-color post post-page">
              <div class="article-box">
    <header class="post-header">
  <h1 class="post-title">
    <a class="post-title-link" href="https://glwlg.top/post/k8s-gao-ke-yong-ji-qun-da-jian-guo-cheng/">
      k8s高可用集群搭建过程
    </a>
  </h1>
  <div class="post-meta">
    
    <span class="meta-item pc-show">
      <i class="fa fa-calendar-o"></i>
      <span>发布于</span>
      <span>2020-01-17</span>
    </span>
    
      <span class="meta-item">
        <span class="post-meta-divider pc-show">|</span>
        <i class="fa fa-folder-o"></i>
        <span class="pc-show">分类于</span>
        
          
            <a href="https://glwlg.top/tag/LjYZDPN3f/">
              <span>kubernetes</span>
            </a>、
          
        
          
            <a href="https://glwlg.top/tag/iZPKpxQR4A/">
              <span>k8s</span>
            </a>、
          
        
          
            <a href="https://glwlg.top/tag/dwvT_Sl49y/">
              <span>docker</span>
            </a>
          
        
      </span>
      <span class="post-meta-divider">|</span>
    
    <span class="meta-item">
      <i class="fa fa-clock-o"></i>
      <span>20分钟</span>
    </span>
    <span class="meta-item">
      <span class="post-meta-divider">|</span>
      <i class="fa fa-file-word-o"></i>
      <span>3376<span class="pc-show">字数</span></span>
    </span>
  </div>
</header>
</div>
              <div class="post-body next-md-body" id="post_body">
                <h1 id="一基础环境搭建">一.基础环境搭建</h1>
<h2 id="11系统配置">1.1系统配置</h2>
<ul>
<li>在安装之前，需要先做如下准备。两台CentOS 7.3主机如下：</li>
</ul>
<pre><code>cat /etc/hosts
192.168.4.113 node1
192.168.4.8 node2
192.168.4.64 node2
</code></pre>
<ul>
<li>如果各个主机启用了防火墙，需要开放Kubernetes各个组件所需要的端口，可以查看<a href="https://kubernetes.io/docs/setup/independent/install-kubeadm/">Installing kubeadm</a>中的”Check required ports”一节。 这里简单起见在各节点禁用防火墙：</li>
</ul>
<pre><code>systemctl stop firewalld
systemctl disable firewalld
</code></pre>
<ul>
<li>创建/etc/sysctl.d/k8s.conf文件，添加如下内容：</li>
</ul>
<pre><code>net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
</code></pre>
<ul>
<li>
<p>执行sysctl -p /etc/sysctl.d/k8s.conf使修改生效。</p>
</li>
<li>
<p>禁用SELINUX：</p>
</li>
</ul>
<pre><code>setenforce 0
</code></pre>
<pre><code>vim /etc/selinux/config
SELINUX=disabled
</code></pre>
<ul>
<li>Kubernetes 1.8开始要求关闭系统的Swap，如果不关闭，默认配置下kubelet将无法启动。可以通过kubelet的启动参数–fail-swap-on=false更改这个限制。 我们这里关闭系统的Swap:</li>
</ul>
<pre><code>swapoff -a
</code></pre>
<ul>
<li>
<p>修改 /etc/fstab 文件，注释掉 SWAP 的自动挂载，使用free -m确认swap已经关闭。</p>
</li>
<li>
<p>swappiness参数调整，修改/etc/sysctl.d/k8s.conf添加下面一行：</p>
</li>
</ul>
<pre><code>vm.swappiness=0
</code></pre>
<ul>
<li>执行sysctl -p /etc/sysctl.d/k8s.conf使修改生效。</li>
</ul>
<h2 id="12安装docker">1.2安装Docker</h2>
<pre><code>yum install -y yum-utils device-mapper-persistent-data lvm2
yum-config-manager \
    --add-repo \
    https://download.docker.com/linux/centos/docker-ce.repo
</code></pre>
<ul>
<li>查看当前的Docker版本：</li>
</ul>
<pre><code>yum list docker-ce.x86_64  --showduplicates |sort -r
docker-ce.x86_64            17.03.2.ce-1.el7.centos             docker-ce-stable
docker-ce.x86_64            17.03.1.ce-1.el7.centos             docker-ce-stable
docker-ce.x86_64            17.03.0.ce-1.el7.centos             docker-ce-stable
</code></pre>
<ul>
<li>Kubernetes 1.8已经针对Docker的1.11.2, 1.12.6, 1.13.1和17.03.2等版本做了验证。 因为我们这里在各节点安装docker的17.03.2版本。</li>
</ul>
<pre><code>yum makecache fast
yum install -y --setopt=obsoletes=0 \
  docker-ce-17.03.2.ce-1.el7.centos \
  docker-ce-selinux-17.03.2.ce-1.el7.centos
</code></pre>
<pre><code>systemctl start docker
systemctl enable docker
</code></pre>
<ul>
<li>Docker从1.13版本开始调整了默认的防火墙规则，禁用了iptables filter表中FOWARD链，这样会引起Kubernetes集群中跨Node的Pod无法通信，在各个Docker节点执行下面的命令</li>
</ul>
<pre><code>iptables -P FORWARD ACCEPT
</code></pre>
<ul>
<li>可在docker的systemd unit文件中以ExecStartPost加入上面的命令：</li>
</ul>
<pre><code>ExecStartPost=/usr/sbin/iptables -P FORWARD ACCEPT
</code></pre>
<pre><code>systemctl daemon-reload
systemctl restart docker
</code></pre>
<h2 id="2安装kubeadm和kubelet">2.安装kubeadm和kubelet</h2>
<ul>
<li>下面在各节点安装kubeadm和kubelet：</li>
</ul>
<pre><code>cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=1
repo_gpgcheck=1
gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg
        https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
EOF
</code></pre>
<ul>
<li>这里要加代理</li>
</ul>
<pre><code>curl https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64
yum makecache fast
yum install -y kubelet kubeadm kubectl

... 
Installed:
  kubeadm.x86_64 0:1.8.0-0     kubectl.x86_64 0:1.8.0-0    kubelet.x86_64 0:1.8.0-0

Dependency Installed:
  kubernetes-cni.x86_64 0:0.5.1-0             socat.x86_64 0:1.7.3.2-2.el7
</code></pre>
<ul>
<li>修改各节点docker的cgroup driver使其和kubelet一致，即修改或创建/etc/docker/daemon.json，加入下面的内容：</li>
</ul>
<pre><code>{
  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;]
}
</code></pre>
<ul>
<li>重启docker:</li>
</ul>
<pre><code>systemctl restart docker
systemctl status docker
</code></pre>
<ul>
<li>在各节点开机启动kubelet服务：</li>
</ul>
<pre><code>systemctl enable kubelet.service
</code></pre>
<h1 id="二集群初始化">二.集群初始化</h1>
<h2 id="21-etcd集群">2.1 etcd集群</h2>
<ul>
<li>在三个主节点用docker启动etcd</li>
</ul>
<pre><code>docker stop etcd &amp;&amp; docker rm etcd
rm -rf /var/lib/etcd-cluster
mkdir -p /var/lib/etcd-cluster
docker run -d \
--restart always \
-v /etc/ssl/certs:/etc/ssl/certs \
-v /var/lib/etcd-cluster:/var/lib/etcd \
-p 4001:4001 \
-p 2380:2380 \
-p 2379:2379 \
--name etcd \
gcr.io/google_containers/etcd-amd64:3.0.17 \
etcd --name=etcd0 \
--advertise-client-urls=http://192.168.4.113:2379,http://192.168.4.113:4001 \
--listen-client-urls=http://0.0.0.0:2379,http://0.0.0.0:4001 \
--initial-advertise-peer-urls=http://192.168.4.113:2380 \
--listen-peer-urls=http://0.0.0.0:2380 \
--initial-cluster-token=3965193498ef91bf92d78922e31be707 \
--initial-cluster=etcd0=http://192.168.4.113:2380,etcd1=http://192.168.4.8:2380,etcd2=http://192.168.4.64:2380 \
--initial-cluster-state=new \
--auto-tls \
--peer-auto-tls \
--data-dir=/var/lib/etcd
</code></pre>
<pre><code>docker stop etcd &amp;&amp; docker rm etcd
rm -rf /var/lib/etcd-cluster
mkdir -p /var/lib/etcd-cluster
docker run -d \
--restart always \
-v /etc/ssl/certs:/etc/ssl/certs \
-v /var/lib/etcd-cluster:/var/lib/etcd \
-p 4001:4001 \
-p 2380:2380 \
-p 2379:2379 \
--name etcd \
gcr.io/google_containers/etcd-amd64:3.0.17 \
etcd --name=etcd1 \
--advertise-client-urls=http://192.168.4.8:2379,http://192.168.4.8:4001 \
--listen-client-urls=http://0.0.0.0:2379,http://0.0.0.0:4001 \
--initial-advertise-peer-urls=http://192.168.4.8:2380 \
--listen-peer-urls=http://0.0.0.0:2380 \
--initial-cluster-token=3965193498ef91bf92d78922e31be707 \
--initial-cluster=etcd0=http://192.168.4.113:2380,etcd1=http://192.168.4.8:2380,etcd2=http://192.168.4.64:2380 \
--initial-cluster-state=new \
--auto-tls \
--peer-auto-tls \
--data-dir=/var/lib/etcd
</code></pre>
<pre><code>docker stop etcd &amp;&amp; docker rm etcd
rm -rf /var/lib/etcd-cluster
mkdir -p /var/lib/etcd-cluster
docker run -d \
--restart always \
-v /etc/ssl/certs:/etc/ssl/certs \
-v /var/lib/etcd-cluster:/var/lib/etcd \
-p 4001:4001 \
-p 2380:2380 \
-p 2379:2379 \
--name etcd \
gcr.io/google_containers/etcd-amd64:3.0.17 \
etcd --name=etcd2 \
--advertise-client-urls=http://192.168.4.64:2379,http://192.168.4.64:4001 \
--listen-client-urls=http://0.0.0.0:2379,http://0.0.0.0:4001 \
--initial-advertise-peer-urls=http://192.168.4.64:2380 \
--listen-peer-urls=http://0.0.0.0:2380 \
--initial-cluster-token=3965193498ef91bf92d78922e31be707 \
--initial-cluster=etcd0=http://192.168.4.113:2380,etcd1=http://192.168.4.8:2380,etcd2=http://192.168.4.64:2380 \
--initial-cluster-state=new \
--auto-tls \
--peer-auto-tls \
--data-dir=/var/lib/etcd
</code></pre>
<h2 id="22-kubeadm初始化">2.2 kubeadm初始化</h2>
<ul>
<li>在node1运行</li>
</ul>
<pre><code>kubeadm init --config=/root/kubeadm-ha/kubeadm-init-v1.8.1.yaml
</code></pre>
<ul>
<li>kubeadm-init-v1.8.1.yaml</li>
</ul>
<pre><code>apiVersion: kubeadm.k8s.io/v1alpha1
kind: MasterConfiguration
api:
  advertiseAddress: 192.168.4.113
kubernetesVersion: v1.8.1
networking:
  podSubnet: 10.244.0.0/16
apiServerCertSANs:
- node1
- node2
- node3
- 192.168.4.113
- 192.168.4.8
- 192.168.4.64
- 192.168.4.2
etcd:
  endpoints:
  - http://192.168.4.113:2379
  - http://192.168.4.8:2379
  - http://192.168.4.64:2379
</code></pre>
<ul>
<li>修改admission-control配置</li>
</ul>
<pre><code>vim /etc/kubernetes/manifests/kube-apiserver.yaml
#    - --admission-control=Initializers,NamespaceLifecycle,LimitRanger,ServiceAccount,PersistentVolumeLabel,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota
    - --admission-control=NamespaceLifecycle,LimitRanger,ServiceAccount,PersistentVolumeLabel,DefaultStorageClass,ResourceQuota,DefaultTolerationSeconds
</code></pre>
<ul>
<li>重启服务</li>
</ul>
<pre><code>systemctl restart docker kubelet
</code></pre>
<pre><code>vim ~/.bashrc
export KUBECONFIG=/etc/kubernetes/admin.conf
source ~/.bashrc
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
</code></pre>
<h2 id="23-flannel网络组件安装">2.3 flannel网络组件安装</h2>
<h3 id="rbac配置">rbac配置</h3>
<ul>
<li>step1-kube-flannel-rbac-v0.9.0.yml</li>
</ul>
<pre><code># Create the clusterrole and clusterrolebinding:
# $ kubectl create -f kube-flannel-rbac.yml
# Create the pod using the same namespace used by the flannel serviceaccount:
# $ kubectl create --namespace kube-system -f kube-flannel.yml
---
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1beta1
metadata:
  name: flannel
rules:
  - apiGroups:
      - &quot;&quot;
    resources:
      - pods
    verbs:
      - get
  - apiGroups:
      - &quot;&quot;
    resources:
      - nodes
    verbs:
      - list
      - watch
  - apiGroups:
      - &quot;&quot;
    resources:
      - nodes/status
    verbs:
      - patch
---
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1beta1
metadata:
  name: flannel
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: flannel
subjects:
- kind: ServiceAccount
  name: flannel
  namespace: kube-system
</code></pre>
<h3 id="flannel配置">flannel配置</h3>
<ul>
<li>step2-kube-flannel-v0.9.0.yml</li>
</ul>
<pre><code>---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: flannel
  namespace: kube-system
---
kind: ConfigMap
apiVersion: v1
metadata:
  name: kube-flannel-cfg
  namespace: kube-system
  labels:
    tier: node
    app: flannel
data:
  cni-conf.json: |
    {
      &quot;name&quot;: &quot;cbr0&quot;,
      &quot;type&quot;: &quot;flannel&quot;,
      &quot;delegate&quot;: {
        &quot;isDefaultGateway&quot;: true
      }
    }
  net-conf.json: |
    {
      &quot;Network&quot;: &quot;10.244.0.0/16&quot;,
      &quot;Backend&quot;: {
        &quot;Type&quot;: &quot;vxlan&quot;
      }
    }
---
apiVersion: extensions/v1beta1
kind: DaemonSet
metadata:
  name: kube-flannel-ds
  namespace: kube-system
  labels:
    tier: node
    app: flannel
spec:
  template:
    metadata:
      labels:
        tier: node
        app: flannel
    spec:
      hostNetwork: true
      nodeSelector:
        beta.kubernetes.io/arch: amd64
      tolerations:
      - key: node-role.kubernetes.io/master
        operator: Exists
        effect: NoSchedule
      serviceAccountName: flannel
      containers:
      - name: kube-flannel
        image: quay.io/coreos/flannel:v0.9.0-amd64
        command: [ &quot;/opt/bin/flanneld&quot;, &quot;--ip-masq&quot;, &quot;--kube-subnet-mgr&quot; , &quot;--iface-regex=enp0s8|wlp3s0&quot;]
        securityContext:
          privileged: true
        env:
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        volumeMounts:
        - name: run
          mountPath: /run
        - name: flannel-cfg
          mountPath: /etc/kube-flannel/
      - name: install-cni
        image: quay.io/coreos/flannel:v0.9.0-amd64
        command: [ &quot;/bin/sh&quot;, &quot;-c&quot;, &quot;set -e -x; cp -f /etc/kube-flannel/cni-conf.json /etc/cni/net.d/10-flannel.conf; while true; do sleep 3600; done&quot; ]
        volumeMounts:
        - name: cni
          mountPath: /etc/cni/net.d
        - name: flannel-cfg
          mountPath: /etc/kube-flannel/
      volumes:
        - name: run
          hostPath:
            path: /run
        - name: cni
          hostPath:
            path: /etc/cni/net.d
        - name: flannel-cfg
          configMap:
            name: kube-flannel-cfg

</code></pre>
<ul>
<li>确认都启动之后再进行下一步</li>
</ul>
<pre><code>kubectl get pods --all-namespaces -o wide
</code></pre>
<h2 id="24-dashboard">2.4 dashboard</h2>
<h3 id="rbac配置-2">rbac配置</h3>
<p>kubernetes-dashboard-admin.rbac.yaml</p>
<pre><code>---
apiVersion: v1
kind: ServiceAccount
metadata:
  labels:
    k8s-app: kubernetes-dashboard
  name: kubernetes-dashboard-admin
  namespace: kube-system
  
---
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: ClusterRoleBinding
metadata:
  name: kubernetes-dashboard-admin
  labels:
    k8s-app: kubernetes-dashboard
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
- kind: ServiceAccount
  name: kubernetes-dashboard-admin
  namespace: kube-system
</code></pre>
<h3 id="dashboard配置">dashboard配置</h3>
<p>kubernetes-dashboard.yaml</p>
<pre><code># Copyright 2017 The Kubernetes Authors.
#
# Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# Configuration to deploy release version of the Dashboard UI compatible with
# Kubernetes 1.7.
#
# Example usage: kubectl create -f &lt;this_file&gt;

# ------------------- Dashboard Secret ------------------- #

apiVersion: v1
kind: Secret
metadata:
  labels:
    k8s-app: kubernetes-dashboard
  name: kubernetes-dashboard-certs
  namespace: kube-system
type: Opaque

---
# ------------------- Dashboard Service Account ------------------- #

apiVersion: v1
kind: ServiceAccount
metadata:
  labels:
    k8s-app: kubernetes-dashboard
  name: kubernetes-dashboard
  namespace: kube-system

---
# ------------------- Dashboard Role &amp; Role Binding ------------------- #

kind: Role
apiVersion: rbac.authorization.k8s.io/v1beta1
metadata:
  name: kubernetes-dashboard-minimal
  namespace: kube-system
rules:
  # Allow Dashboard to create and watch for changes of 'kubernetes-dashboard-key-holder' secret.
- apiGroups: [&quot;&quot;]
  resources: [&quot;secrets&quot;]
  verbs: [&quot;create&quot;, &quot;watch&quot;]
- apiGroups: [&quot;&quot;]
  resources: [&quot;secrets&quot;]
  # Allow Dashboard to get, update and delete 'kubernetes-dashboard-key-holder' secret.
  resourceNames: [&quot;kubernetes-dashboard-key-holder&quot;, &quot;kubernetes-dashboard-certs&quot;]
  verbs: [&quot;get&quot;, &quot;update&quot;, &quot;delete&quot;]
  # Allow Dashboard to get metrics from heapster.
- apiGroups: [&quot;&quot;]
  resources: [&quot;services&quot;]
  resourceNames: [&quot;heapster&quot;]
  verbs: [&quot;proxy&quot;]

---
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: RoleBinding
metadata:
  name: kubernetes-dashboard-minimal
  namespace: kube-system
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: kubernetes-dashboard-minimal
subjects:
- kind: ServiceAccount
  name: kubernetes-dashboard
  namespace: kube-system

---
# ------------------- Dashboard Deployment ------------------- #

kind: Deployment
apiVersion: extensions/v1beta1
metadata:
  labels:
    k8s-app: kubernetes-dashboard
  name: kubernetes-dashboard
  namespace: kube-system
spec:
  replicas: 3
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      k8s-app: kubernetes-dashboard
  template:
    metadata:
      labels:
        k8s-app: kubernetes-dashboard
    spec:
      initContainers:
      - name: kubernetes-dashboard-init
        image: gcr.io/google_containers/kubernetes-dashboard-init-amd64:v1.0.1
        volumeMounts:
        - name: kubernetes-dashboard-certs
          mountPath: /certs
      containers:
      - name: kubernetes-dashboard
        image: gcr.io/google_containers/kubernetes-dashboard-amd64:v1.7.1
        ports:
        - containerPort: 9443
          protocol: TCP
        args:
           - --authentication-mode=token
           - --port=9443
           - --tls-key-file=/certs/dashboard.key
           - --tls-cert-file=/certs/dashboard.crt
          # Uncomment the following line to manually specify Kubernetes API server Host
          # If not specified, Dashboard will attempt to auto discover the API server and connect
          # to it. Uncomment only if the default does not work.
          # - --apiserver-host=http://my-address:port
        volumeMounts:
        - name: kubernetes-dashboard-certs
          mountPath: /certs
          readOnly: true
          # Create on-disk volume to store exec logs
        - mountPath: /tmp
          name: tmp-volume
        livenessProbe:
          httpGet:
            scheme: HTTPS
            path: /
            port: 9443
          initialDelaySeconds: 30
          timeoutSeconds: 30
      volumes:
      - name: kubernetes-dashboard-certs
        secret:
          secretName: kubernetes-dashboard-certs
      - name: tmp-volume
        emptyDir: {}
      serviceAccountName: kubernetes-dashboard
      # Comment the following tolerations if Dashboard must not be deployed on master
      tolerations:
      - key: node-role.kubernetes.io/master
        effect: NoSchedule
      nodeSelector:
        role: master

---
# ------------------- Dashboard Service ------------------- #

kind: Service
apiVersion: v1
metadata:
  labels:
    k8s-app: kubernetes-dashboard
  name: kubernetes-dashboard
  namespace: kube-system
spec:
  ports:
    - port: 443
      targetPort: 9443
      nodePort: 30000
      protocol: TCP
  selector:
    k8s-app: kubernetes-dashboard
  type: NodePort
</code></pre>
<ul>
<li>获取token</li>
</ul>
<pre><code>kubectl -n kube-system get secret | grep kubernetes-dashboard-admin
kubectl describe -n kube-system secret/kubernetes-dashboard-admin-token-pfss5
</code></pre>
<p>访问192.168.4.113:30000验证</p>
<h3 id="heapster组件安装">heapster组件安装</h3>
<ul>
<li>在k8s-master1上允许在master上部署pod，否则heapster会无法部署</li>
</ul>
<pre><code>kubectl taint nodes --all node-role.kubernetes.io/master-
</code></pre>
<ul>
<li>在k8s-master1上安装heapster组件，监控性能</li>
</ul>
<pre><code>kubectl create -f /root/kubeadm-ha/kube-heapster
</code></pre>
<ul>
<li>重启服务</li>
</ul>
<pre><code>systemctl restart docker kubelet
</code></pre>
<h1 id="三master集群高可用设置">三.master集群高可用设置</h1>
<h2 id="31-修改配置">3.1 修改配置</h2>
<ul>
<li>在node1上把/etc/kubernetes/复制node2、node3</li>
</ul>
<pre><code>scp -r /etc/kubernetes/ k8s-master2:/etc/
scp -r /etc/kubernetes/ k8s-master3:/etc/
</code></pre>
<ul>
<li>在node2 ,node3上重启kubelet服务，并检查kubelet服务状态为active (running)</li>
</ul>
<pre><code>systemctl daemon-reload &amp;&amp; systemctl restart kubelet
</code></pre>
<pre><code>vim ~/.bashrc
export KUBECONFIG=/etc/kubernetes/admin.conf
source ~/.bashrc
</code></pre>
<ul>
<li>在node2 ,node3检测节点状态，这个时候只能看到node1,因为配置还没改</li>
</ul>
<pre><code>kubectl get nodes -o wide
</code></pre>
<ul>
<li>修改node2,node3的以下文件,改ip为本机ip</li>
</ul>
<pre><code>vim /etc/kubernetes/manifests/kube-apiserver.yaml
vim /etc/kubernetes/kubelet.conf
vim /etc/kubernetes/admin.conf
vim /etc/kubernetes/controller-manager.conf
vim /etc/kubernetes/scheduler.conf
</code></pre>
<ul>
<li>重启所有节点服务</li>
</ul>
<pre><code>systemctl daemon-reload &amp;&amp; systemctl restart docker kubelet
</code></pre>
<h2 id="32-验证">3.2 验证</h2>
<ul>
<li>这个时候应该有3个节点了</li>
</ul>
<pre><code>kubectl get nodes -o wide
kubectl get pod --all-namespaces -o wide | grep node2
</code></pre>
<ul>
<li>修改插件容器数量</li>
</ul>
<pre><code>kubectl scale --replicas=3 -n kube-system deployment/kube-dns
kubectl scale --replicas=3 -n kube-system deployment/kubernetes-dashboard
kubectl scale --replicas=3 -n kube-system deployment/heapster
kubectl scale --replicas=3 -n kube-system deployment/monitoring-grafana
kubectl scale --replicas=3 -n kube-system deployment/monitoring-influxdb

kubectl get pods --all-namespaces -o wide| grep kube-dns
kubectl get pods --all-namespaces -o wide| grep kubernetes-dashboard
kubectl get pods --all-namespaces -o wide| grep heapster
kubectl get pods --all-namespaces -o wide| grep monitoring-grafana
kubectl get pods --all-namespaces -o wide| grep monitoring-influxdb
</code></pre>
<h2 id="33-keepalived安装配置">3.3 keepalived安装配置</h2>
<ul>
<li>下面操作在三个节点进行</li>
</ul>
<pre><code> yum install -y keepalived

systemctl enable keepalived &amp;&amp; systemctl restart keepalived
</code></pre>
<ul>
<li>备份原配置</li>
</ul>
<pre><code> mv /etc/keepalived/keepalived.conf /etc/keepalived/keepalived.conf.bak
</code></pre>
<ul>
<li>check_apiserver.sh</li>
</ul>
<pre><code>vim /etc/keepalived/check_apiserver.sh

#!/bin/bash
err=0
for k in $( seq 1 10 )
do
    check_code=$(ps -ef|grep kube-apiserver | wc -l)
    if [ &quot;$check_code&quot; = &quot;1&quot; ]; then
        err=$(expr $err + 1)
        sleep 5
        continue
    else
        err=0
        break
    fi
done
if [ &quot;$err&quot; != &quot;0&quot; ]; then
    echo &quot;systemctl stop keepalived&quot;
    /usr/bin/systemctl stop keepalived
    exit 1
else
    exit 0
fi

chmod a+x /etc/keepalived/check_apiserver.sh
</code></pre>
<ul>
<li>修改配置</li>
<li>keepalived.conf</li>
</ul>
<pre><code>! Configuration File for keepalived
global_defs {
    router_id LVS_DEVEL
}
vrrp_script chk_apiserver {
    script &quot;/etc/keepalived/check_apiserver.sh&quot;
    interval 2
    weight -5
    fall 3  
    rise 2
}
vrrp_instance VI_1 {
    state MASTER
    interface enp0s8
    mcast_src_ip 192.168.4.113
    virtual_router_id 51
    priority 102
    advert_int 2
    authentication {
        auth_type PASS
        auth_pass 4be37dc3b4c90194d1600c483e10ad1d
    }
    virtual_ipaddress {
        192.168.4.2
    }
    track_script {
       chk_apiserver
    }
}
</code></pre>
<ul>
<li>重启服务</li>
</ul>
<pre><code>systemctl restart keepalived
</code></pre>
<h2 id="34-nginx负载均衡配置">3.4 nginx负载均衡配置</h2>
<ul>
<li>nginx-default.conf</li>
</ul>
<pre><code>vim /root/kubeadm-ha/nginx-default.conf

user  nginx;
worker_processes  1;

error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;


events {
    worker_connections  1024;
}


http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    log_format  main  '$remote_addr - $remote_user [$time_local] &quot;$request&quot; '
                      '$status $body_bytes_sent &quot;$http_referer&quot; '
                      '&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;';

    access_log  /var/log/nginx/access.log  main;

    sendfile        on;
    #tcp_nopush     on;

    keepalive_timeout  65;

    #gzip  on;

    include /etc/nginx/conf.d/*.conf;
}

stream {
	upstream apiserver {
	    server 192.168.4.113:6443 weight=5 max_fails=3 fail_timeout=30s;
	    server 192.168.4.8:6443 weight=5 max_fails=3 fail_timeout=30s;
	    server 192.168.4.64:6443 weight=5 max_fails=3 fail_timeout=30s;
	}

    server {
        listen 8443;
        proxy_connect_timeout 1s;
        proxy_timeout 3s;
        proxy_pass apiserver;
    }
}
</code></pre>
<ul>
<li>运行nginx</li>
</ul>
<pre><code>docker run -d -p 8443:8443 \
--name nginx-lb \
--restart always \
-v /root/kubeadm-ha/nginx-default.conf:/etc/nginx/nginx.conf \
nginx
</code></pre>
<h2 id="35-kube-proxy配置">3.5 kube-proxy配置</h2>
<ul>
<li>在k8s-master1上修改configmap/kube-proxy的server指向keepalived的虚拟IP地址</li>
</ul>
<pre><code>kubectl edit -n kube-system configmap/kube-proxy
server: https://192.168.4.2:8443
</code></pre>
<ul>
<li>在k8s-master1上查看configmap/kube-proxy设置情况</li>
</ul>
<pre><code>kubectl get -n kube-system configmap/kube-proxy -o yaml
</code></pre>
<ul>
<li>在k8s-master1上删除所有kube-proxy的pod，让proxy重建</li>
</ul>
<pre><code>kubectl get pods --all-namespaces -o wide | grep proxy
</code></pre>
<ul>
<li>在k8s-master1、k8s-master2、k8s-master3上重启docker kubelet keepalived服务</li>
</ul>
<pre><code>systemctl restart docker kubelet keepalived
</code></pre>
<h1 id="四-node节点加入高可用集群设置">四. node节点加入高可用集群设置</h1>
<ul>
<li>kubeadm加入高可用集群</li>
<li>在k8s-master1上禁止在所有master节点上发布应用</li>
</ul>
<pre><code>kubectl patch node node1 -p '{&quot;spec&quot;:{&quot;unschedulable&quot;:true}}'
kubectl patch node node2 -p '{&quot;spec&quot;:{&quot;unschedulable&quot;:true}}'
kubectl patch node node3 -p '{&quot;spec&quot;:{&quot;unschedulable&quot;:true}}'
</code></pre>
<ul>
<li>在k8s-master1上查看集群的token</li>
</ul>
<pre><code>kubeadm token list
kubeadm join --token ${TOKEN} ${VIRTUAL_IP}:8443
</code></pre>
<ul>
<li>默认的token24小时过期,可以重新创建一个</li>
</ul>
<pre><code>kubeadm token create
</code></pre>

              </div>
              <div class="post-footer">
  <ul class="post-copyright">
    <li class="post-copyright-author">
      <strong>本文作者：</strong>
      我的笔记
    </li>
    <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://glwlg.top/post/k8s-gao-ke-yong-ji-qun-da-jian-guo-cheng/" title="k8s高可用集群搭建过程">k8s高可用集群搭建过程</a>
    </li>
    <li class="post-copyright-license">
      <strong>版权声明： </strong>
      本博客所有文章除特别声明外，转载请注明出处！
    </li>
  </ul>
  <div class="tags">
    
      <a href="https://glwlg.top/tag/LjYZDPN3f/"># kubernetes</a>
    
      <a href="https://glwlg.top/tag/iZPKpxQR4A/"># k8s</a>
    
      <a href="https://glwlg.top/tag/dwvT_Sl49y/"># docker</a>
    
  </div>
  <div class="nav">
    <div class="nav-prev">
      
        <i class="fa fa-chevron-left"></i>
        <a class="nav-pc-next" title="Docker on WSL" href="https://glwlg.top/post/docker-on-wsl/">Docker on WSL</a class="nav-pc-next">
        <a class="nav-mobile-prev" title="Docker on WSL" href="https://glwlg.top/post/docker-on-wsl/">上一篇</a>
      
    </div>
    <div class="nav-next">
      
        <a class="nav-pc-next" title="nginx-rewrite" href="https://glwlg.top/post/nginx-rewrite/">nginx-rewrite</a>
        <a class="nav-mobile-next" title="nginx-rewrite" href="https://glwlg.top/post/nginx-rewrite/">下一篇</a>
        <i class="fa fa-chevron-right"></i>
      
    </div>
  </div>
</div>
              
            </div>
          </div>
        </div>
      </div>
      <div class="footer-box">
  <footer class="footer">
    <div class="copyright">
      © 2019-2020 theme by HsxyHao
    </div>
    <div class="poweredby">
      Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a> </br>
<a target="_blank" rel="noopener noreferrer" class="chakra-link line1 css-f4h6uy" href="https://beian.miit.gov.cn/">浙ICP备2022008290号-2</a>
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?fd531c8be921dea9866df7182037ac91";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

    </div>
  </footer>
  
  
    <div class="drawer-box left" id="drawer_box">
      <span class="muse-line muse-line-first"></span>
      <span class="muse-line muse-line-middle"></span>
      <span class="muse-line muse-line-last"></span>
    </div>
  
  <div class="mist back-to-top" id="back_to_top">
    <i class="fa fa-arrow-up"></i>
    
  </div>
  
  
    <link rel="stylesheet" href="/media/live2d/histoire/css/live2d.css" />
<div class="box-scale">
  <div id="landlord" style="left:5px;bottom:0px;" data-key="">
    <div class="message" style="opacity:0"></div>
    <canvas id="live2d" width="500" height="560" class="live2d"></canvas>
    <div class="live_talk_input_body">
      <div class="live_talk_input_name_body">
        <input name="name" type="text" class="live_talk_name white_input" id="AIuserName" autocomplete="off" placeholder="你的名字" />
      </div>
      <div class="live_talk_input_text_body">
        <input name="talk" type="text" class="live_talk_talk white_input" id="AIuserText" autocomplete="off" placeholder="要和我聊什么呀？"/>
        <button type="button" class="live_talk_send_btn" id="talk_send">发送</button>
      </div>
    </div>
    <input name="live_talk" id="live_talk" value="1" type="hidden" />
    <div class="live_ico_box">
      <div class="live_ico_item type_info" id="showInfoBtn"></div>
      <div class="live_ico_item type_talk" id="showTalkBtn"></div>
      
      <div class="live_ico_item type_youdu" id="youduButton"></div>
      <div class="live_ico_item type_quit" id="hideButton"></div>
      <input name="live_statu_val" id="live_statu_val" value="0" type="hidden" />
      <audio src="" style="display:none;" id="live2d_bgm" data-bgm="0" preload="none"></audio>
      <input id="duType" value="douqilai" type="hidden">
      
    </div>
  </div>
</div>
<div id="open_live2d">召唤伊斯特瓦尔</div>
<script type="text/javascript" src="https://apps.bdimg.com/libs/jquery/1.7.1/jquery.min.js"></script>
<script>
var message_Path = '/media/live2d/histoire/';
let landlord = document.querySelector('#landlord');
var apiKey = landlord.dataset.key;
</script>
<script type="text/javascript" src="/media/live2d/histoire/js/live2d.js"></script>
<script type="text/javascript" src="/media/live2d/histoire/js/message.js"></script>
  
  
</div>
<script>

  let sideBarOpen = 'sidebar-open';
  let body = document.body;
  let back2Top = document.querySelector('#back_to_top'),
  back2TopText = document.querySelector('#back_to_top_text'),
  drawerBox = document.querySelector('#drawer_box'),
  rightSideBar = document.querySelector('.sidebar'),
  viewport = document.querySelector('body');

  function scrollAnimation(currentY, targetY) {
   
    let needScrollTop = targetY - currentY
    let _currentY = currentY
    setTimeout(() => {
      const dist = Math.ceil(needScrollTop / 10)
      _currentY += dist
      window.scrollTo(_currentY, currentY)
      if (needScrollTop > 10 || needScrollTop < -10) {
        scrollAnimation(_currentY, targetY)
      } else {
        window.scrollTo(_currentY, targetY)
      }
    }, 1)
  }

  back2Top.addEventListener("click", function(e) {
    scrollAnimation(document.scrollingElement.scrollTop, 0);
    e.stopPropagation();
    return false;
  });
  
  window.addEventListener('scroll', function(e) {
    let percent = document.scrollingElement.scrollTop / (document.scrollingElement.scrollHeight - document.scrollingElement.clientHeight) * 100;
    if (percent > 1 && !back2Top.classList.contains('back-top-active')) {
      back2Top.classList.add('back-top-active');
    }
    if (percent == 0) {
      back2Top.classList.remove('back-top-active');
    }
    if (back2TopText) {
      back2TopText.textContent = Math.floor(percent);
    }
  });

  
  let hasCacu = false;
  window.onresize = function() {
    if (window.width > 991) {
      calcuHeight();
    } else {
      hasCacu = false;
    }
  }

  function calcuHeight() {
    // 动态调整站点概览高度
    if (!hasCacu && back2Top.classList.contains('pisces') || back2Top.classList.contains('gemini')) {
      let sideBar = document.querySelector('.sidebar');
      let navUl = document.querySelector('#site_nav');
      sideBar.style = 'margin-top:' + (navUl.offsetHeight + navUl.offsetTop + 15) + 'px;';
      hasCacu = true;
    }
  }
  calcuHeight();
  
  let open = false, MOTION_TIME = 300, RIGHT_MOVE_DIS = '320px';

  if (drawerBox) {
    let rightMotions = document.querySelectorAll('.right-motion');
    let right = drawerBox.classList.contains('right');

    let transitionDir = right ? "transition.slideRightIn" : "transition.slideLeftIn";

    let openProp, closeProp;
    if (right) {
      openProp = {
        paddingRight: RIGHT_MOVE_DIS 
      };
      closeProp = {
        paddingRight: '0px'
      };
    } else {
      openProp = {
        paddingLeft: RIGHT_MOVE_DIS 
      };
      closeProp = {
        paddingLeft: '0px'
      };
    }

    drawerBox.onclick = function() {
      open = !open;
      window.Velocity(rightSideBar, 'stop');
      window.Velocity(viewport, 'stop');
      window.Velocity(rightMotions, 'stop');
      if (open) {
        window.Velocity(rightSideBar, {
          width: RIGHT_MOVE_DIS
        }, {
          duration: MOTION_TIME,
          begin: function() {
            window.Velocity(rightMotions, transitionDir,{ });
          }
        })
        window.Velocity(viewport, openProp,{
          duration: MOTION_TIME
        });
      } else {
        window.Velocity(rightSideBar, {
          width: '0px'
        }, {
          duration: MOTION_TIME,
          begin: function() {
            window.Velocity(rightMotions, {
              opacity: 0
            });
          }
        })
        window.Velocity(viewport, closeProp ,{
          duration: MOTION_TIME
        });
      }
      for (let i = 0; i < drawerBox.children.length; i++) {
        drawerBox.children[i].classList.toggle('muse-line');
      }
      drawerBox.classList.toggle(sideBarOpen);
    }
  }

  // 代码高亮
  hljs.initHighlightingOnLoad();
</script>
    </div>
  </body>
  <script src="/media/js/motion.js"></script>
</html>